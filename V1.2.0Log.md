 # PulseBench V1.2.0 (beta) — Release Notes

 Release date: 2025-11-17

 This document describes the V1.2.0 beta update to PulseBench. It goes into detail about
 what was added, how each new file integrates with the project, and how to use the
 new features (CLI, JSON/CSV export, unit tests, presets, and plotting).

 Summary of major changes
 - Improved CLI with `--workload`, `--threads`, `--duration`, `--workset`, `--output`, `--format`, `--list`, and `--config <file>`.
 - Export results to JSON (rich output) and CSV (single-line summary).
 - Improved statistics: added `Stats` struct, median, percentiles (50/90/99), and a simple histogram.
 - New example workloads: `memcpy` (memory-bound) and `io` (file-append I/O workload) in addition to `simd`.
 - Unit tests for stats using Catch2, integrated into CMake (FetchContent).
 - Preset JSON config examples under `examples/` and a convenience `examples/example.sh` demonstrating usage.
 - Simple plotting helper `scripts/plot_results.py` that visualizes JSON/CSV outputs (histogram + percentiles).
 - CMake enhancements to fetch `nlohmann/json` and `Catch2` via FetchContent and add a `tests` target.

 Files added or modified in this release

 - `include/stats.hpp` (modified)
   - Introduces the `Stats` struct: mean, median, stddev, min, max and a `percentiles` map.
   - Declares `percentile()` helper and `compute_stats()` which computes full statistics from a sample vector.

 - `src/stats.cpp` (modified)
   - Implements `percentile()` (linear interpolation between sorted sample indices), `compute_stats()` and improved numeric stability.
   - `compute_stats()` returns a `Stats` object filled with requested percentiles (defaults: 50, 90, 99).

 - `src/workloads.cpp` (modified)
   - Keeps `SIMDWorkload` implementation and registers two new workloads:
     - `memcpy` — memory streaming / memcpy work to stress memory bandwidth.
     - `io` — appends small blocks to `/tmp/pulsebench_io_test.bin` to stress I/O.
   - These example workloads are intentionally simple and easy to inspect; you can extend them or replace them with real-world workloads.

 - `src/main.cpp` (modified)
   - Adds a more powerful CLI and configuration loader using `nlohmann::json`:
     - `--workload <name>` choose which workload to run (e.g. `simd`, `memcpy`, `io`).
     - `--duration <seconds>` how long to run the benchmark.
     - `--threads <n>` number of worker threads.
     - `--workset <bytes>` size of the working set passed to the workload init.
     - `--output <file>` and `--format <json|csv>` write results to disk.
     - `--list` shows registered workloads and exits.
     - `--config <file>` loads a JSON config file (see `examples/config_*.json`).
   - Per-batch timings are collected (millisecond resolution) and used to compute `Stats`.
   - Print a compact throughput metric (`batches/sec`) instead of a large cumulative score.
   - JSON export now includes `stats.percentiles` and `histogram_bins` (10 bins) in addition to summary fields.

 - `examples/example.sh` (modified)
   - Updated to show `--list`, `--config` usage and JSON/CSV output examples.

 - `examples/config_simd.json`, `examples/config_io.json` (added)
   - Example presets that can be passed to `--config` to run reproducible benchmark runs.

 - `scripts/plot_results.py` (added)
   - Small Python script using `matplotlib` to visualize the JSON/CSV outputs produced by the CLI.
   - Plots histogram bins and percentiles for JSON outputs and prints summary for CSV outputs.

 - `CMakeLists.txt` (modified)
   - Adds `FetchContent` usage for `Catch2` and `nlohmann/json`.
   - Adds `tests` target at `tests/test_stats.cpp` that links Catch2 and `src/stats.cpp` to run unit tests.

 - `tests/test_stats.cpp` (added)
   - Catch2 based unit tests exercising `mean`, `median`, `stddev`, `percentile` and `compute_stats`.


 JSON output schema (example and description)

 Example (pretty-printed):

 ```json
 {
   "workload": "simd",
   "threads": 4,
   "duration_seconds": 10,
   "total_batches": 12345,
   "throughput_batches_per_s": 1234.500,
   "stats": {
     "mean_ms": 0.812,
     "median_ms": 0.799,
     "stddev_ms": 0.045,
     "min_ms": 0.700,
     "max_ms": 1.200,
     "percentiles": {
       "50": 0.799,
       "90": 0.900,
       "99": 1.150
     }
   },
   "histogram_bins": [150, 1200, 3400, 4200, 1600, 400, 150, 80, 30, 5]
 }
 ```

 Fields:
 - `workload`: workload name used.
 - `threads`: number of worker threads.
 - `duration_seconds`: run length in seconds.
 - `total_batches`: number of `run_batch()` calls completed across all threads.
 - `throughput_batches_per_s`: compact score = `total_batches / duration_seconds` (recommended metric).
 - `stats`: per-sample statistics (in milliseconds): mean, median, stddev, min, max and a `percentiles` map.
 - `histogram_bins`: 10 histogram bins counting how many samples fall into each bucket from min->max.

 CSV output format

 Header row contains:
 ```
 workload,threads,duration_seconds,total_batches,throughput_bps,mean_ms,median_ms,stddev_ms,min_ms,max_ms
 ```

 How to run the new features

 - Build and run tests (Catch2 fetch is automatic via CMake):

 ```bash
 mkdir -p build && cd build
 cmake .. -DBUILD_TESTS=ON
 make -j
 ./tests          # run Catch2 unit tests
 ```

 - Run a benchmark using a config preset:

 ```bash
 ./pulsebench --config ../examples/config_simd.json
 ```

 - Run and write JSON output:

 ```bash
 ./pulsebench --workload simd --duration 10 --threads 4 --output results.json --format json
 ```

 - Plot results:

 ```bash
 python3 scripts/plot_results.py results.json
 ```

 Developer notes and caveats

 - The new `io` workload writes to `/tmp/pulsebench_io_test.bin` for demonstration. Clean up if you use it repeatedly.
 - The histogram is a simple linear binning between observed min and max sample values. For skewed distributions consider log-binning.
 - The `memcpy` workload uses allocations sized from the `--workset` argument; adjust to model your target working set.
 - No external runtime dependencies were added to the main program; `nlohmann/json` is fetched at build time and linked into the binary.

 What's next

 - Add more unit tests across the codebase (workload registry, workload behavior, utils).  
 - Consider adding a flag to emit raw samples to disk (disabled by default to avoid large files).  
 - Add GitHub Actions to run `cmake --build` and `ctest` on PRs.  

 If you find issues running the new binaries or tests in your environment please open an issue with the command you ran and the platform details.
